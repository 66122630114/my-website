<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #2c3e50; 
            --secondary: #3498db;
            --success: #27ae60;
            --bg: #ecf0f1; 
            --card: #ffffff;
            --text: #2c3e50;
            --text-light: #7f8c8d;
            --border: #bdc3c7;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        * { box-sizing: border-box; }
        
        body { 
            font-family: 'Sarabun', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 15px;
        }
        
        .container { max-width: 1300px; margin: 0 auto; }

        header { 
            background: linear-gradient(135deg, var(--primary) 0%, #34495e 100%);
            color: white; 
            padding: 30px; 
            border-radius: 10px; 
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 20px;
        }
        
        .header-title h1 { margin: 0; font-size: 28px; font-weight: 600; }
        .header-title p { margin: 8px 0 0; opacity: 0.95; font-size: 14px; }
        
        .btn { 
            padding: 10px 18px; 
            border-radius: 6px; 
            text-decoration: none; 
            font-weight: 600; 
            border: none; 
            cursor: pointer; 
            transition: all 0.3s ease;
            display: inline-flex; 
            align-items: center; 
            gap: 6px; 
            font-size: 14px;
            white-space: nowrap;
        }
        
        .btn-light { background: rgba(255, 255, 255, 0.95); color: var(--primary); }
        .btn-export { background: var(--success); color: white; }
        .btn-clear { background: transparent; color: #e74c3c; text-decoration: underline; font-size: 13px; cursor: pointer; border:none; }

        /* Filter Bar */
        .filter-bar { 
            background: var(--card); padding: 20px; border-radius: 10px; 
            margin-bottom: 25px; box-shadow: var(--shadow); border: 1px solid #e0e0e0;
        }
        
        .filter-controls { display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group label { font-size: 13px; font-weight: 600; text-transform: uppercase; }
        .form-control { padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; min-width: 160px; }

        /* Cards */
        .summary-cards { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .card { 
            background: var(--card); padding: 22px; border-radius: 10px;
            box-shadow: var(--shadow); border-top: 4px solid var(--primary);
        }
        .card .number { font-size: 32px; font-weight: bold; color: var(--primary); }
        .card .sub-text { font-size: 12px; color: var(--text-light); }

        /* Charts */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .chart-box { background: var(--card); padding: 22px; border-radius: 10px; box-shadow: var(--shadow); }
        .chart-box h3 { margin-top: 0; border-bottom: 2px solid #ecf0f1; padding-bottom: 15px; font-size: 16px; }
        
        .bar-chart-row { margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
        .bar-label { width: 140px; font-size: 13px; text-align: right; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .bar-track { flex-grow: 1; background: #ecf0f1; height: 24px; border-radius: 12px; overflow: hidden; }
        .bar-fill { height: 100%; background: linear-gradient(90deg, var(--secondary), var(--primary)); width: 0%; transition: width 0.6s ease; }
        .bar-value { width: 45px; text-align: right; font-size: 13px; font-weight: bold; }

        /* Table */
        .table-container { background: var(--card); padding: 25px; border-radius: 10px; box-shadow: var(--shadow); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 14px 16px; text-align: left; font-size: 14px; border-bottom: 1px solid #ecf0f1; }
        th { background: #f8f9fa; font-weight: 600; text-transform: uppercase; font-size: 12px; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; background: #e8f4f8; color: var(--secondary); font-weight: 600; }

        /* Loading Overlay */
        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.8); display: flex; justify-content: center; 
            align-items: center; z-index: 1000; font-weight: bold;
        }
    </style>
</head>
<body>

<div id="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

<div class="container">
    <header>
        <div class="header-title">
            <h1>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h1>
            <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• (Client-side Version)</p>
        </div>
        <div class="header-actions">
            <button onclick="location.reload()" class="btn btn-light">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
    </header>

    <div class="filter-bar">
        <p style="margin:0 0 15px 0; font-weight:600;">üîç ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
        <div class="filter-controls">
            <div class="form-group">
                <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
                <input type="text" id="searchInp" class="form-control" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." oninput="applyFilters()">
            </div>
            <div class="form-group">
                <label>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</label>
                <select id="deviceSel" class="form-control" onchange="applyFilters()">
                    <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
                </select>
            </div>
            <div class="form-group">
                <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                <select id="typeSel" class="form-control" onchange="applyFilters()">
                    <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
                </select>
            </div>
            <div class="filter-btn-group">
                <button onclick="clearFilters()" class="btn-clear">‚úï ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
            </div>
        </div>
    </div>

    <div class="summary-cards">
        <div class="card">
            <h3>üìå ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏ö</h3>
            <div id="stat-count" class="number">0</div>
            <div class="sub-text">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
        </div>
        <div class="card">
            <h3>‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°</h3>
            <div id="stat-time" class="number">0</div>
            <div class="sub-text">‡∏ô‡∏≤‡∏ó‡∏µ</div>
        </div>
        <div class="card">
            <h3>üìà ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</h3>
            <div id="stat-avg" class="number">0</div>
            <div class="sub-text">‡∏ô‡∏≤‡∏ó‡∏µ / ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
        </div>
        <div class="card" style="border-top-color: var(--success);">
            <h3>‚¨áÔ∏è ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
            <button onclick="exportToCSV()" class="btn btn-export">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</button>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="chart-box">
            <h3>üì¶ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3>
            <div id="chart-device"></div>
        </div>
        <div class="chart-box">
            <h3>üè∑Ô∏è ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</h3>
            <div id="chart-type"></div>
        </div>
    </div>

    <div class="table-container">
        <h3>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (50 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</h3>
        <table>
            <thead>
                <tr>
                    <th style="width: 15%;">‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ</th>
                    <th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
                    <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                    <th>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
                    <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                </tr>
            </thead>
            <tbody id="table-body">
                </tbody>
        </table>
    </div>
</div>

<script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTSjf_ppDd3pJ3KrHeP99nI0J-l8jne8GyawbZfj42M5DP8xdh4dg7ifxeW4iirvQbIM99DhNDXaDYA/pub?gid=1095863488&single=true&output=csv";
    
    let rawData = [];
    let filteredData = [];

    // 1. Fetch Data
    async function fetchData() {
        try {
            const response = await fetch(CSV_URL);
            const text = await response.text();
            processData(text);
            document.getElementById('loading').style.display = 'none';
        } catch (error) {
            console.error("Error fetching data:", error);
            alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ");
        }
    }

    // 2. Parse CSV
    function processData(csvText) {
        const lines = csvText.split('\n');
        const headers = lines[0].split(',');
        
        rawData = lines.slice(1).filter(line => line.trim() !== '').map(line => {
            // Simple CSV split (not handling commas inside quotes for brevity)
            const cols = line.split(',');
            return {
                date: cols[0] || '-',
                topic: cols[1] || '-',
                type: cols[2] || '-',
                device: cols[3] || '-',
                duration_str: cols[4] || '0 ‡∏ô‡∏≤‡∏ó‡∏µ',
                minutes: parseInt(cols[4]?.replace(/\D/g, '') || 0)
            };
        });

        populateFilters();
        applyFilters();
    }

    // 3. Populate Select Options
    function populateFilters() {
        const devices = [...new Set(rawData.map(d => d.device))].sort();
        const types = [...new Set(rawData.map(d => d.type))].sort();
        
        const devSel = document.getElementById('deviceSel');
        const typSel = document.getElementById('typeSel');

        devices.forEach(d => devSel.innerHTML += `<option value="${d}">${d}</option>`);
        types.forEach(t => typSel.innerHTML += `<option value="${t}">${t}</option>`);
    }

    // 4. Apply Filters & Logic
    function applyFilters() {
        const search = document.getElementById('searchInp').value.toLowerCase();
        const device = document.getElementById('deviceSel').value;
        const type = document.getElementById('typeSel').value;

        filteredData = rawData.filter(item => {
            const matchSearch = item.topic.toLowerCase().includes(search) || item.device.toLowerCase().includes(search);
            const matchDevice = device === '' || item.device === device;
            const matchType = type === '' || item.type === type;
            return matchSearch && matchDevice && matchType;
        });

        renderDashboard();
    }

    // 5. Render UI
    function renderDashboard() {
        // Stats
        const totalMinutes = filteredData.reduce((sum, item) => sum + item.minutes, 0);
        document.getElementById('stat-count').innerText = filteredData.length.toLocaleString();
        document.getElementById('stat-time').innerText = totalMinutes.toLocaleString();
        document.getElementById('stat-avg').innerText = filteredData.length > 0 ? (totalMinutes / filteredData.length).toFixed(1) : 0;

        // Table (Sort by date string approx - for better sorting, parse date objects)
        const tableBody = document.getElementById('table-body');
        tableBody.innerHTML = '';
        
        // Show last 50
        const displayList = [...filteredData].reverse().slice(0, 50);
        
        if (displayList.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
        } else {
            displayList.forEach(item => {
                tableBody.innerHTML += `
                    <tr>
                        <td>${item.date}</td>
                        <td>${item.topic}</td>
                        <td><span class="badge">${item.type}</span></td>
                        <td>${item.device}</td>
                        <td>${item.duration_str}</td>
                    </tr>
                `;
            });
        }

        renderCharts();
    }

    // 6. Manual Bar Charts
    function renderCharts() {
        const deviceCounts = {};
        const typeCounts = {};

        filteredData.forEach(item => {
            deviceCounts[item.device] = (deviceCounts[item.device] || 0) + 1;
            typeCounts[item.type] = (typeCounts[item.type] || 0) + 1;
        });

        const draw = (obj, targetId, color) => {
            const sorted = Object.entries(obj).sort((a,b) => b[1] - a[1]);
            const target = document.getElementById(targetId);
            target.innerHTML = '';
            
            sorted.forEach(([label, value]) => {
                const percent = (value / filteredData.length) * 100;
                target.innerHTML += `
                    <div class="bar-chart-row">
                        <div class="bar-label">${label}</div>
                        <div class="bar-track"><div class="bar-fill" style="width:${percent}%; ${color}"></div></div>
                        <div class="bar-value">${value}</div>
                    </div>
                `;
            });
        };

        draw(deviceCounts, 'chart-device', '');
        draw(typeCounts, 'chart-type', 'background: linear-gradient(90deg, #9c27b0, #673ab7);');
    }

    function clearFilters() {
        document.getElementById('searchInp').value = '';
        document.getElementById('deviceSel').value = '';
        document.getElementById('typeSel').value = '';
        applyFilters();
    }

    // 7. Export CSV
    function exportToCSV() {
        let csvContent = "\uFEFF‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠,‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó,‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå,‡πÄ‡∏ß‡∏•‡∏≤\n";
        filteredData.forEach(row => {
            csvContent += `${row.date},${row.topic},${row.type},${row.device},${row.duration_str}\n`;
        });
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", "report_export.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Start
    fetchData();
</script>

</body>
</html>
